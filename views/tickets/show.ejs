<% layout('partials/boilerplate') -%>

<div class="container mt-5">
  <div class="row">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h2><%= ticket.eventName %></h2>
            <span class="badge bg-light text-dark fs-6"><%= ticket.eventCategory %></span>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h5>📅 Event Date</h5>
              <p><%= ticket.eventDate.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></p>
              
              <h5>📍 Location</h5>
              <p><%= ticket.location %></p>
              
              <h5>🏷️ Price</h5>
              <p class="fs-4 text-success fw-bold">₹<%= ticket.pricePerTicket.toLocaleString('en-IN') %></p>
              
              <h5>🎫 Available Tickets</h5>
              <p>
                <span class="badge bg-<%= ticket.ticketsAvailable > 5 ? 'success' : ticket.ticketsAvailable > 0 ? 'warning' : 'danger' %>">
                  <%= ticket.ticketsAvailable %> tickets left
                </span>
              </p>
            </div>
            
            <div class="col-md-6">
              <h5>👤 Seller</h5>
              <p><%= ticket.owner.username %></p>
              
              <h5>📝 Description</h5>
              <p><%= ticket.description || 'No description provided.' %></p>
              
              <h5>📊 Status</h5>
              <p>
                <% if (ticket.status === 'available') { %>
                  <span class="badge bg-success">Available</span>
                <% } else if (ticket.status === 'booked') { %>
                  <span class="badge bg-info">Booked</span>
                <% } else { %>
                  <span class="badge bg-secondary">Cancelled</span>
                <% } %>
              </p>
            </div>
          </div>
          
          <% if (ticket.status === 'available' && ticket.ticketsAvailable > 0) { %>
            <div class="alert alert-warning">
              <h5>⚠️ Important Notice</h5>
              <p>All sales are final. Please review event details carefully before purchasing.</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card shadow sticky-top" style="top: 20px;">
        <div class="card-body">
          <% if (!currentUser) { %>
            <div class="alert alert-info">
              <h5>🔐 Login Required</h5>
              <p>Please <a href="/users/login">login</a> to book this ticket.</p>
            </div>
          <% } else if (ticket.owner._id.toString() === currentUser._id.toString()) { %>
            <!-- Owner controls -->
            <div class="d-grid gap-2">
              <a href="/tickets/<%= ticket._id %>/edit" class="btn btn-warning">✏️ Edit Ticket</a>
              <form action="/tickets/<%= ticket._id %>?_method=DELETE" method="POST">
                <button class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this ticket?')">🗑️ Delete Ticket</button>
              </form>
            </div>
          <% } else if (ticket.status === 'available' && ticket.ticketsAvailable > 0) { %>
            <!-- Booking form for available tickets -->
            <div class="text-center">
              <h4>Total: ₹<%= ticket.pricePerTicket.toLocaleString('en-IN') %></h4>
              <form action="/tickets/<%= ticket._id %>/book" method="POST">
                <button type="submit" class="btn btn-success btn-lg w-100 mt-3">
                  🎫 Book Now
                </button>
              </form>
              <small class="text-muted">By booking, you agree to our terms and conditions.</small>
            </div>
          <% } else if (ticket.status === 'booked' && ticket.bookedBy && ticket.bookedBy._id.toString() === currentUser._id.toString()) { %>
            <!-- Controls for ticket booked by current user -->
            <div class="text-center">
              <div class="alert alert-success">
                <h5>✅ Your Ticket</h5>
                <p>You have booked this ticket.</p>
              </div>
              <a href="/tickets/<%= ticket._id %>/confirmation" class="btn btn-info w-100 mb-2">
                🎟️ View Confirmation
              </a>
              <a href="/tickets/<%= ticket._id %>/cancel" class="btn btn-danger w-100"
                 onclick="return confirm('Are you sure you want to cancel this ticket? A refund will be initiated.')">
                ❌ Cancel Ticket
              </a>
            </div>
          <% } else { %>
            <!-- Ticket unavailable -->
            <div class="alert alert-secondary text-center">
              <h5>🎫 Ticket Unavailable</h5>
              <p>This ticket is currently not available for booking.</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>